# ワークフロー詳細

## 1. 作業指示の分析

ユーザーの指示から以下を特定：
- 作業タイプ（調査/実装/ビルド/テスト/レビュー）
- 複数作業の場合は依存関係
- 並列実行の可能性

## 2. 実行計画の提示

### 単一作業の場合

```
━━━━━━━━━━━━━━━━━━━━━━━━━
📋 実行計画
━━━━━━━━━━━━━━━━━━━━━━━━━

作業: [research-web] React フォームライブラリ調査

サブエージェントに委譲して実行します。
よろしいですか？
━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 複数作業の場合

```
━━━━━━━━━━━━━━━━━━━━━━━━━
📋 実行計画
━━━━━━━━━━━━━━━━━━━━━━━━━

フェーズ1 (並列実行):
  ├─ [research-web] React フォームライブラリ調査
  └─ [research-code] 既存フォーム実装の確認

フェーズ2 (順次実行):
  └─ [implement] 新フォーム実装

この計画で進めてよろしいですか？
━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 3. サブエージェントの起動

### タスク起動のデフォルト方針

**原則：run_in_background: true をデフォルトとする**

| 状況 | 設定 | 理由 |
|------|------|------|
| 複数タスク | true | 並列実行で高速化 |
| 単一タスク | true | 他作業の余地を残す |
| 結果が即座に必要 | false | 待機が必須の場合のみ |

**メリット**：
- メインコンテキストが他の作業を継続可能
- 複数タスクの並列実行で時間短縮
- ユーザーへの応答性向上

**結果取得**：
- TaskOutput(task_id, block: true) で結果を待機
- 複数タスクの場合は並列で TaskOutput を呼び出し

### 基本呼び出し形式

```
Task(
  subagent_type: "general-purpose",
  model: "opus",
  prompt: "[ULTRATHINK MODE - 深く検討して実行してください]

タスク: <タスク説明>

## 目的
<具体的な目標>

## 実行内容
<詳細な指示>

## 期待する成果物
- <成果物1>
- <成果物2>

## 報告フォーマット
### サマリー
<3-5行の要約>

### 詳細
<詳細な内容>

### 推奨事項
<次のステップへの提案>

### 参照情報
<URL、ファイルパス等>
",
  description: "<短いタスク説明>",
  run_in_background: true
)
```

### 並列実行時

単一メッセージで複数起動：
```
Task(タスク1, run_in_background: true)
Task(タスク2, run_in_background: true)
```

## 4. 結果の収集

**バックグラウンド実行の場合**：

```
# 進捗確認（ノンブロッキング）
AgentOutputTool(agentId: "<id>", block: false)

# 結果取得（ブロッキング）
AgentOutputTool(agentId: "<id>", block: true)
```

## 5. 結果報告とネクストアクション

**完了報告**：
```
━━━━━━━━━━━━━━━━━━━━━━━━━
📊 完了報告
━━━━━━━━━━━━━━━━━━━━━━━━━

## サマリー
<サブエージェントからの要約>

## 主要な発見/成果
1. <ポイント1>
2. <ポイント2>
3. <ポイント3>

## 次のアクション
- [ ] <推奨アクション1>
- [ ] <推奨アクション2>
━━━━━━━━━━━━━━━━━━━━━━━━━
```

## タスクタイプ別プロンプト

**building-task-prompts Skill** を使用してプロンプトを生成する。
詳細なテンプレートは `building-task-prompts/templates/` を参照。

### クイックリファレンス

| タスクタイプ | 主要なプロンプト要素 |
|--------------|---------------------|
| research-web | 検索キーワード、評価基準、サマリー形式 |
| research-code | 対象パターン、ファイルスコープ、分析深度 |
| root-cause-analysis | エラー内容、再現手順、仮説、調査範囲 |
| implement | 要件、制約、既存パターン |
| build | ビルドコマンド、期待出力、エラー処理 |
| test | テストスコープ、カバレッジ要件、失敗時処理 |
| review | レビュー基準、重点領域、出力形式 |
